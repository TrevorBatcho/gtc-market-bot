name: Daily Snapshot (09:00 Dubai)

on:
  schedule:
    # 09:00 Dubai (UTC+4) == 05:00 UTC
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  daily_snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Daily Snapshot to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          RUN_MODE: daily
        run: |
          python send_once.py

      # === Twitter/X post (v2) ===
      # Requires these repo secrets already set:
      #   TWITTER_API_KEY, TWITTER_API_SECRET, TWITTER_ACCESS_TOKEN, TWITTER_ACCESS_SECRET
      - name: Post Snapshot to Twitter
        if: always()
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python - <<'PY'
          import os, tweepy

          client = tweepy.Client(
              consumer_key=os.environ["TWITTER_API_KEY"],
              consumer_secret=os.environ["TWITTER_API_SECRET"],
              access_token=os.environ["TWITTER_ACCESS_TOKEN"],
              access_token_secret=os.environ["TWITTER_ACCESS_SECRET"],
          )

          text = (
              "ðŸ“Š GTC Academy â€” Daily Market Snapshot is live on Telegram!\n"
              "#Forex #Gold #BTC #SPX #Markets"
          )
          try:
              client.create_tweet(text=text[:280])
              print("Tweet posted successfully.")
          except Exception as e:
              print("Tweet failed:", e)
          PY
